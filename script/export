#!/usr/bin/env node

const { figma } = require('../package.json')
const { progress, downloadSVG } = require('./utils.js')
const fs = require('fs-extra')
const path = require('path')
const SVGO = require('svgo')
const yaml = require('js-yaml')
const got = require('got')
const spinner = require('ora')("")

// Fail if there's no figma file key
let figmaFileKey;
try {
  figmaFileKey = figma.url.match(/file\/([a-z0-9]+)\//i)[1]
} catch (e) {
  console.error("Cannot find figma file key in package.json!", e)
  return process.exit(1)
}

const {
  FIGMA_DOMAIN = 'api.figma.com',
  FIGMA_TOKEN
} = process.env

if (!FIGMA_TOKEN) {
  console.error('You must set FIGMA_TOKEN to a Figma personal access token.')
  process.exit(1)
}

spinner.info(`Exporting octicons from ${figma.url} file`)

// Where we're putting the exported SVG and data.json
// so the libraries can use it
const outputDir = path.resolve(__dirname, "../lib/build")

let dCount = 0
let oCount = 0

// Clear the build directory
fs.removeSync(outputDir)

// Get the components
getFigmaComponents()
  .then(components => {
    // Map all components to a new object
    return components.reduce((data, c) => {

      // Keywords extracted from description when that's ready
      let keywords = (c.description || "").match(/^keywords: (.+)$/mi)

      // If we have a match, get keywords and split by comma
      keywords = keywords ? keywords.pop().split(", ") : []

      // Create a data object
      data[c.name] = {
        name: c.name,
        figma: {
          id: c.id,
          file: figmaFileKey
        },
        keywords: keywords,
        width: c.absoluteBoundingBox.width,
        height: c.absoluteBoundingBox.height,
      }

      return data
    }, {})
  })
  .then(data => {

    const icons = Object.values(data)
    // Make a query string with all the component ids
    let componentIds = icons.map(c => c.figma.id ).join(",")

    // Request all the image export URLs from figma
    return getFigmaImageUrls(componentIds)
      .then(images => {

        let svgo = new SVGO(Object.assign(
          {},
          yaml.safeLoad(fs.readFileSync(path.resolve(__dirname,'../.svgo.yml'), 'utf8'))
        ))

        spinner.info("Downloading SVG files from aws")
        spinner.start("")

        // For each octicon
        return Promise.all(icons.map(icon => {
          return got.get(images[icon.figma.id], {
              headers: {
                "Content-Type": "images/svg+xml"
              }
            })
            .on('downloadProgress', () => {
              spinner.text = `${progress(dCount, oCount)} Downloading ${icon.name} icon`
            })
            .then(response => {
              const svg = response.body
              dCount++
              return svgo.optimize(svg, {})
                .then(optimized => {
                  icon.path = optimized.data.slice(optimized.data.indexOf('>') + 1).slice(0, -6)
                  return fs.ensureDir(path.join(outputDir, "/svg"))
                    .then(() => fs.writeFileSync(path.resolve(outputDir, `svg/${icon.name}.svg`), optimized.data, "utf8"))
                })
                .catch((err) => {
                  console.error("Something went wrong optimizing the svg data!", err)
                  process.exit(1)
                })
            })
        }))
    })
    .then(() => {
      spinner.stopAndPersist({
        text: `${progress(dCount, oCount)} ${Object.keys(data).length} icons downloaded`
      })
      spinner.info("Writing data out to lib/build/data.json")
      fs.writeFileSync(path.resolve(outputDir, `data.json`), JSON.stringify(icons), "utf8")
      console.warn("\nAll done! Icons successfully exported.")
    })

  })
  .catch(err => {
    console.error(err)
    process.exitCode = 1
  })

function getFigmaComponents() {
  spinner.info("Getting components from the figma file")
  spinner.start(`Contacting ${FIGMA_DOMAIN}`)
  return got.get(`${FIGMA_DOMAIN}/v1/files/${figmaFileKey}`, {
      headers: {
        "Content-Type": "application/json",
        "x-figma-token": FIGMA_TOKEN
      },
      json: true
    })
    .then(response => {
      spinner.start(`Processing response`)
      const {document, components} = response.body
      const canvas = getCanvas(document, 'Octicons')
      return canvas.children
        .filter(child => {
          return child.type == "COMPONENT"
        })
        .map(child => {
          child.description = components[child.id].description
          return child
        })
    })
    .then(components => {
      oCount = components.length
      spinner.succeed(`${oCount} icons found in the figma file`)
      return components
    })
    .catch(err => {
      spinner.fail("Error: Getting getting octicons from figma file")
      throw err
    })
}

function getFigmaImageUrls(componentIds) {
  spinner.info("Exporting figma components as SVG")
  return got.get(`${FIGMA_DOMAIN}/v1/images/${figmaFileKey}`, {
      query: {
        ids: componentIds,
        format: "svg"
      },
      headers: {
        "Content-Type": "application/json",
        "x-figma-token": FIGMA_TOKEN
      },
      json: true
    })
    .then(response => {
      if (response.body.err) {
        throw response.body.err
      } else {
        spinner.succeed(`Successfully exported components`)
        return response.body.images
      }
    })
}

function getCanvas(doc, name) {
  const matched = doc.children
    .filter(child => child.type === 'CANVAS' && child.name === name)
  if (!matched.length) {
    throw new Error(`Unable to find canvas named "${name}"`)
  }
  return matched[0]
}
